<!doctype html>
<!--[if IE 9]><html class="lt-ie10" lang="en" > <![endif]-->
<html>
<head>

    <title>bits - Requirements and Ticketing System</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    
    <link rel="stylesheet" href="static/foundation/css/foundation.css" />
    
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css"> 
    
    <!--<script src="//code.jquery.com/jquery-1.10.2.js"></script>-->
    
    
    <style>
    
        div.login-wrapper {
            
        }
    
        div.login-box {
            width: 300px;
            margin: auto;
            padding: 15px;
        }
    
        div.content-wrapper {
            display: none;
        }
    
        div.top-links a{
            display: none;
            padding-left: 20px;
        }
    
        div.right-padding a {
            padding-right: 20px;
        }
        
        /*
        div.pages div {
            display: none;
        }
        */

        div.left-padding {
            padding-left: 20px;
        }
        
        #current-organization {
            color: #008CBA;
        }
    
    </style>

</head>
<body>

    <div class="row">
        <div class="large-12 columns">
            <div class="right">
                <h4><div id="current-organization"></div><small><div id="current-project"></div></small></h4>
            </div>
            <h2>bits</h2>
            <hr/>
        </div>
    </div>
    
    <div class="login-wrapper" id="login-wrapper">
        <!--
        <div class="row">
            <div class="large-4 medium-4 columns">
            -->
                <div class="login-box">
                    <h3>Login <small>you must login to continue</small></h3>
                    <input placeholder="email" type="text" id="login-email">
                    <input placeholder="password" type="text" id="login-password">
                    <a href="#" class="small radius button right" id="login-button">Login</a>
                </div>
                <!--
            </div>
        </div>
        -->
    </div>
    
    <div class="content-wrapper" id="content-wrapper">
    
        <div class="row">
            <div class="large-12 columns">
                <div class="top-links">
                    <a href="#" id="top-link-organizations">Organizations</a>
                    <a href="#" id="top-link-projects">Projects</a>
                    <a href="#" id="top-link-requirements">Requirements</a>
                    <a href="#" id="top-link-tickets">Tickets</a>
                    <a href="#" id="top-link-discussions">Discussions</a>
                    <a href="#" id="top-link-notes">Notes</a>
                    <div class="right right-padding">
                        <a href="#" id="top-link-help">Help</a>
                    </div>
                </div>
                <hr/>
            </div>
        </div>    
        
        <div class="row">
            <div class="large-12 columns" roll="content" id="main-content">
                <div id="pages" class="pages">
                    <div id="page-organizations">
                        <a href="#" class="small radius button right" id="button-new-organization">New Organization</a>
                        <h4>Organizations You Below To</h4>
                        <br/>
                        <div id="page-organizations-inside"></div>
                    </div>
                    <div id="page-projects">
                        <a href="#" class="small radius button right" id="button-new-project">New Project</a>
                        <h4>Your Projects</h4>
                        <br/>
                        <div id="page-projects-inside"></div>
                    </div>
                    <div id="page-requirements">
                        <a href="#" class="small radius button right" id="button-new-requirement">New Requirement</a>
                        <h4>Project Requirements</h4>
                        <br/>
                        <div id="page-requirements-inside"></div>
                    </div>
                    <div id="page-tickets">
                        <a href="#" class="small radius button right" id="button-new-ticket">New Ticket</a>
                        <h4>Project Tickets</h4>
                        <br/>
                        <div id="page-tickets-inside"></div>
                    </div>
                    <div id="page-ticket">
                        <div id="page-ticket-inside">
                            <div class="large-12 columns">
                                <label>Title</label>
                                <input placeholder="title" type="text">
                            </div>
                            <div class="large-12 columns">
                                <label>Details</label>
                                <textarea placeholder="markdown supported"></textarea>
                            </div>
                            <a href="#" class="small radius button right" id="button-create-ticket">Create Ticket</a>
                         </div>
                    </div>
                    <div id="page-discussions">
                        <a href="#" class="small radius button right" id="button-new-discussion">New Discussion</a>
                        <h4>Project Discussions</h4>
                        <br/>
                        <div id="page-discussions-inside"></div>
                    </div>
                    <div id="page-notes">
                        <a href="#" class="small radius button right" id="button-new-note">New Note</a>
                        <h4>Project Notes</h4>
                        <br/>
                        <div id="page-notes-inside"></div>
                    </div>
                    <div id="page-help">
                        <div id="page-help-inside"></div>
                    </div>
                </div>
            </div>
            <!--
            <aside class="large-2 columns" style="border-left: 1px solid #777;">
                <h4>Options</h4>
                <ul class="side-nav">
                    
                    <li><a href="#">News</a></li>
                    <li><a href="#">Code</a></li>
                    <li><a href="#">Design</a></li>
                    <li><a href="#">Fun</a></li>
                    <li><a href="#">Weasels</a></li>
                    
                </ul>
            </aside>
           --> 
        </div>
    
    </div>

    <script src="static/foundation/js/vendor/jquery.js"></script>
    <script src="static/foundation/js/foundation.min.js"></script>
    <script src="static/foundation/js/vendor/modernizr.js"></script>
    <!--<script src="Foundation/js/foundation/foundation.js"></script>-->
    
    <script src="//code.jquery.com/ui/1.11.1/jquery-ui.js"></script>

    <script>
        $(document).foundation();
    </script>
    
    <script>
        
        // login stuff
        var token = '';
        var urls = {};
        var current_organization = {
            name: '',
            id: 0
        }
        var current_project = {
            name: '',
            id: 0
        }
        
        var pages = [
            'organizations',
            'projects',
            'requirements',
            'tickets',
            'ticket',
            'discussions',
            'notes',
            'help'
        ]
        
        var active_pages = [
            'organizations',
            'help',
        ]
        
        $(document).ready( function() {
            
            hide_content();
            set_organization(0,'');
            set_project(0,'');
            update_links();
            
            // setup our login button
            $('#login-button').on('click', function(e) {
                var email = $('#login-email').val();
                var password = $('#login-password').val();
                var url = "authenticate.json?email="+email+'&password='+password;
                $.ajax({
                    dataType:'json',
                    url: url,
                    success: function(data) {
                        if( data.success == true ) {
                            //console.log('Login successful.');
                            init_credentials(data.token);
                            hide_login();
                            switch_page('organizations');
                        }
                    },
                    error: function(data) {
                        // TODO: report error
                    }
                });
            });
            
            // setup our pages
            pages.forEach( function(page) {
                $('#top-link-'+page).on('click', function(e) {
                    switch_page(page);
                });
            });
            
            $('#button-new-ticket').on('click', function(e) {
                switch_page('ticket');
            });
            
            $('#button-create-ticket').on('click', function(e) {
                console.log('creating ticket ...');
                $.ajax({
                    dataType: 'json',
                    type: 'POST',
                    data: {
                        author_id : '',
                        project_id : '',
                        title : '',
                        contents : ''
                    },
                    url: urls['create_ticket'],
                    success: function(data) {
                        if( data.success == true ) {
                            console.log('SUCCESS!');
                        }
                    },
                    error: function(data) {
                        console.log('an error happened while creating ticket ...');
                        // TODO: report error
                    }
                });
            });
        
        });
        
        function init_credentials(new_token) {
            token = new_token;
            
            urls['get_organizations'] = 'get_organizations.json?token='+new_token;
            urls['get_projects'] = 'get_projects.json?token='+new_token;
            urls['create_ticket'] = 'create_ticket.json?token='+new_token;
            
        }
        
        function hide_login() {
            $('#login-wrapper').hide();
        }
        
        function show_login() {
            $('#login-wrapper').show();
        }
        
        function hide_content() {
            $('#content-wrapper').hide();
        }
        
        function show_content() {
            $('#content-wrapper').show();
        }
        
        function hide_all_pages() {
            pages.forEach( function(page) {
                $('#page-'+page).hide()
            });
        }
        
        function show_page(page_name) {
            $('#page-'+page_name).show()
        }
        
        function switch_page(page_name) {
            
            $('#content-wrapper').show();
            hide_all_pages();
            show_page(page_name);
            process_page(page_name);
        }
        
        function add_active_page(page_name) {
            if ( active_pages.indexOf(page_name) >= 0 ) {
                // link already shown, no need to do anything
            }
            else {
                active_pages.push(page_name);
            }
        }
        
        function update_links() {
            active_pages.forEach( function(link) {
                $('#top-link-'+link).show();
            });
        }
        
        function process_page(page_name) {
            switch (page_name) {
                case 'organizations':
                    $.ajax({
                        dataType: 'json',
                        url: urls['get_organizations'],
                        success: function(data) {
                            if (data.success == true ) {
                                populate_organizations(data.organizations);
                            }
                            else {
                                // TODO: redirect to login page
                            }
                        },
                        error: function(data) {
                            // TODO: report error
                        }
                    });
                    
                    break;
                    
                case 'projects':
                    $.ajax({
                        dataType: 'json',
                        url: urls['get_projects'],
                        success: function(data) {
                            if (data.success == true ) {
                                populate_projects(data.projects);
                            }
                            else {
                                // TODO: redirect to login page
                            }
                        },
                        error: function(data) {
                            // TODO: report error
                        }
                    });
                    break;
                case 'requirements':
                    break;
                case 'tickets':
                    break;
                case 'discussions':
                    break;
                case 'notes':
                    break;
                case 'help':
                    break;
                default:
                    break;
            };
            
        }        
        
        // ------- organizations -------- //
        
        function populate_organizations(organizations) {
            console.log('populating orgaization list');
            html = '';
            organizations.forEach(function(org) {
                html += '<div class="organization-wrapper left-padding">';
                html += '<h4><a href="#" id="" class="large" orgname="' + org.organization_name + '" orgid="' + org.organization_id + '">' + org.organization_name + '</a> ';
                html += '<small>' + org.organization_description + '</small></h4>';
                html += 'Owner: <a href="#">' + org.auther_first + ' ' + org.auther_last + '( ' + org.author_email  + ' )</a>';
                html += '<hr>';
                html += '</div>';
            });
            console.log(html);
            $('#page-organizations-inside').html(html);
            $('#page-organizations').on('click', function(e) {
                console.log('click!');
                //console.log(e.target.attr('organizationname'));
                var orgid = $(e.target).attr('orgid');
                var orgname = $(e.target).attr('orgname');
                //console.log(orgname);
                set_organization(orgid, orgname);
                add_active_page('projects');
                update_links();
                switch_page('projects');
            });
        }
        
        function set_organization(orgid, orgname) {
            current_organization.name = orgname;
            current_organization.id = orgid;
            $('#current-organization').html(current_organization.name);
        }
        
        
        
        // ------ projects ------ ///
        
        function populate_projects(projects) {
            console.log('populating project list');
            html = '';
            projects.forEach(function(project) {
                html += '<div class="project-wrapper left-padding">';
                html += '<h4><a href="#" id="" class="large" projectname="' + project.project_name + '" projectid="' + project.project_id + '">' + project.project_name + '</a> ';
                html += '<small>' + project.project_description + '</small></h4>';
                html += 'Owner: <a href="#">' + project.auther_first + ' ' + project.auther_last + '( ' + project.author_email  + ' )</a>';
                html += '<hr>';
                html += '</div>';
            });
            console.log(html);
            $('#page-projects-inside').html(html);
            $('#page-projects').on('click', function(e) {
                console.log('click!');
                var projectid = $(e.target).attr('projectid');
                var projectname = $(e.target).attr('projectname');
                set_project(projectid, projectname);
                add_active_page('requirements');
                add_active_page('tickets');
                add_active_page('discussions');
                add_active_page('notes');
                update_links();
                switch_page('projects');
            });
        }
        
        function set_project(projectid, projectname) {
            current_project.name = projectname;
            current_project.id = projectid;
            $('#current-project').html(current_project.name);
        }
        
    </script>

</body>
</html>
